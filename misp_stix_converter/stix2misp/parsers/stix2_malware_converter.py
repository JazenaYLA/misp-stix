#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from ... import Mapping
from ..exceptions import UnknownParsingFunctionError
from .stix2mapping import (
    ExternalSTIX2Mapping, InternalSTIX2Mapping, STIX2Mapping)
from .stix2converter import ExternalConverter, InternalConverter, STIX2Converter
from abc import ABCMeta
from pymisp import MISPGalaxyCluster
from stix2.v20.sdo import Malware as Malware_v20
from stix2.v21.sdo import Malware as Malware_v21
from typing import Optional, Union

_MAIN_PARSER_TYPING = Union[
    'ExternalSTIX2toMISPParser', 'InternalSTIX2toMISPParser'
]
_MALWARE_TYPING = Union[
    Malware_v20, Malware_v21
]


class MalwareMapping(STIX2Mapping):
    __malware_meta_mapping = Mapping(
        aliases='synonyms',
        architecture_execution_envs='architecture_execution_envs',
        capabilities='capabilities',
        implementation_languages='implementation_languages',
        is_family='is_family',
        malware_types='malware_types',
        operating_system_refs='operating_system_refs',
        sample_refs='sample_refs'
    )

    @classmethod
    def malware_meta_mapping(cls) -> dict:
        return cls.__malware_meta_mapping


class MalwareConverter(STIX2Converter, metaclass=ABCMeta):
    def __init__(self, main: _MAIN_PARSER_TYPING):
        self._set_main_parser(main)
    
    def _create_cluster(self, malware: _MALWARE_TYPING,
                        description: Optional[str] = None,
                        galaxy_type: Optional[str] = None) -> MISPGalaxyCluster:
        malware_args = self._create_cluster_args(
            malware, galaxy_type, description=description
        )
        meta = self._handle_meta_fields(malware)
        if hasattr(malware, 'external_references'):
            meta.update(
                self._handle_external_references(malware.external_references)
            )
        if hasattr(malware, 'kill_chain_phases'):
            meta['kill_chain'] = self._handle_kill_chain_phases(
                malware.kill_chain_phases
            )
        if hasattr(malware, 'labels'):
            self._handle_labels(meta, malware.labels)
        if meta:
            malware_args['meta'] = meta
        return self._create_misp_galaxy_cluster(malware_args)

    def _parse_malware_object(self, malware: _MALWARE_TYPING):
        misp_object = self._create_misp_object('malware', malware)
        return misp_object


class ExternalMalwareMapping(MalwareMapping, ExternalSTIX2Mapping):
    pass


class ExternalMalwareConverter(MalwareConverter, ExternalConverter):
    def __init__(self, main: 'ExternalSTIX2toMISPParser'):
        super().__init__(main)
        self._mapping = ExternalMalwareMapping

    def parse(self, malware_ref: str):
        malware = self.main_parser._get_stix_object(malware_ref)
        if hasattr(malware, 'sample_refs'):
            if malware.is_family:
                self._parse_malware_object_and_galaxy(malware)
            else:
                self._parse_malware_object(malware)
        elif getattr(malware, 'is_family', True) and hasattr(malware, 'name'):
            self._parse_galaxy(malware)
        else:
            self._parse_malware_object(malware)


class InternalMalwareMapping(MalwareMapping, InternalSTIX2Mapping):
    __script_object_mapping = Mapping(
        name=STIX2Mapping.filename_attribute(),
        description=InternalSTIX2Mapping.comment_text_attribute(),
        implementation_languages=STIX2Mapping.language_attribute(),
        x_misp_script=InternalSTIX2Mapping.script_attribute(),
        x_misp_state=InternalSTIX2Mapping.state_attribute()
    )

    @classmethod
    def script_object_mapping(cls) -> dict:
        return cls.__script_object_mapping


class InternalMalwareConverter(MalwareConverter, InternalConverter):
    def __init__(self, main: 'InternalSTIX2toMISPParser'):
        super().__init__(main)
        self._mapping = InternalMalwareMapping

    def parse(self, malware_ref: str):
        malware = self.main_parser._get_stix_object(malware_ref)
        feature = self._handle_object_mapping(malware.labels, malware.id)
        try:
            parser = getattr(self, feature)
        except AttributeError:
            raise UnknownParsingFunctionError(feature)
        try:
            parser(malware)
        except Exception as exception:
            self.main_parser._attack_pattern_error(malware.id, exception)

    def _parse_script_object(self, malware: _MALWARE_TYPING):
        misp_object = self._create_misp_object('script', malware)
        for key, mapping in self._mapping.script_object_mapping().items():
            if hasattr(malware, key):
                self._populate_object_attributes(
                    misp_object,
                    mapping,
                    getattr(malware, key)
                )
        if hasattr(malware, 'x_misp_script_as_attachment'):
            attribute = {
                'type': 'attachment',
                'object_relation': 'script-as-attachment'
            }
            if isinstance(malware.x_misp_script_as_attachment, dict):
                attribute.update(malware.x_misp_script_as_attachment)
            else:
                attribute['value'] = malware.x_misp_script_as_attachment
            misp_object.add_attribute(**attribute)
        self.main_parser._add_misp_object(misp_object, malware)